---
title: "Technical Appendix"
format: 
  html:
    toc: true
    toc-location: left
    code-fold: show
    theme: cosmo
---

```{r}
library(tidycensus)
library(tidyverse)
library(here)
library(lubridate)
library(dplyr)
library(sf)
library(tigris)
library(spatstat)
library(terra)
library(ggplot2)
library(arrow)


```
```{r}
df=read.csv(here("data/philadelphia_weekly_2020_2021 (1).csv"))
df$week_date <- ymd(df$week_date)
df$first_of_month=floor_date(df$week_date,"month")
df$days_since_first=as.numeric(df$week_date-df$first_of_month)
df$week_of_month <- ceiling((df$days_since_first + 1) / 7)
summary(df)
```


```{r}
acs_tables <- load_variables(year = 2023, dataset = "acs5", cache = TRUE)

```

```{r}
census_path <- here("data", "Philly Census")

census_shp_path <- file.path(census_path, "philly_tract.shp")

philly_tract_sf <- st_read(census_shp_path, quiet = TRUE)
```


Variables Collected:

Median gross rent: (B25064)

Race: (B02001)

Median household income: (B19013)

% of Renter: (B25003)

Year Built(renter): (B25036)

Number of Room: (B25017)

Room Per Household: (B25020)

Family Structure: (B11001)

Unemployment in labor force: (C18120)

Gross Rent as a Percentage of Household Income: (B25070)

### census data collected

```{r api key, eval=TRUE, include=FALSE}

census_api_key <- ("138db656646183a18ae51e4a7c1e1f5cd64d4b40")

# Define parameters
my_state  <- "Pennsylvania"
my_county <- "Philadelphia"
acs_year  <- 2023

# Median Gross Rent
median_rent <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25064_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rent = estimate)

# Race
race <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B02001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_pop = B02001_001,
    white = B02001_002,
    black = B02001_003,
    asian = B02001_005,
    pct_white = 100 * white / total_pop,
    pct_black = 100 * black / total_pop,
    pct_asian = 100 * asian / total_pop
  ) %>%
  select(GEOID, total_pop, pct_white, pct_black, pct_asian)

# Median Household Income
median_income <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B19013_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_hh_income = estimate)

# Percent Renter
tenure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_occupied = B25003_001,
    renter_occupied = B25003_003,
    pct_renter = 100 * renter_occupied / total_occupied
  ) %>%
  select(GEOID, pct_renter)

# Median Year Built - Renter Occupied
year_built_renter <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25037_003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_year_built_renter = estimate)

# Number of Rooms
num_rooms <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25017_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, aggregate_rooms = estimate)

# Median Rooms Per Household 
rooms_per_hh <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25018_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rooms = estimate)

# Family Structure 
family_structure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B11001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_hh = B11001_001,
    family_hh = B11001_002,
    nonfamily_hh = B11001_007,
    pct_family = 100 * family_hh / total_hh
  ) %>%
  select(GEOID, total_hh, pct_family)

# Unemployment in Labor Force (C18120)
unemployment <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "C18120",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    in_labor_force = C18120_002,
    unemployed = C18120_004,
    pct_unemployed = 100 * unemployed / in_labor_force
  ) %>%
  select(GEOID, pct_unemployed)

# Gross Rent as Percentage of Household Income ()
rent_burden <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25070",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total = B25070_001,
    # Rent burdened = paying 30%+ of income on rent
    rent_burdened = B25070_007 + B25070_008 + B25070_009 + B25070_010,
    pct_rent_burdened = 100 * rent_burdened / total
  ) %>%
  select(GEOID, pct_rent_burdened)

#Join All data
philly_tract_data <- median_rent %>%
  left_join(race, by = "GEOID") %>%
  left_join(median_income, by = "GEOID") %>%
  left_join(tenure, by = "GEOID") %>%
  left_join(year_built_renter, by = "GEOID") %>%
  left_join(num_rooms, by = "GEOID") %>%
  left_join(rooms_per_hh, by = "GEOID") %>%
  left_join(family_structure, by = "GEOID") %>%
  left_join(unemployment, by = "GEOID") %>%
  left_join(rent_burden, by = "GEOID")
```


### Dewey rental data
```{r}
folder_path <- "data/rental-in-philly"

all_parquet_files <- open_dataset(
  sources = folder_path, 
  format = "parquet"
)

combined_df <- all_parquet_files %>%
  collect()


rental_shp=combined_df%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

  
api_url <- "https://services.arcgis.com/fLeGjb7u4uXqeF9q/arcgis/rest/services/City_Limits/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
city_limits_data <- st_read(api_url)

rental_shp_proj <- st_transform(rental_shp, crs = 32618)
city_limits_data_proj <- st_transform(city_limits_data, crs = 32618)


phillyrental_proj <- st_filter(rental_shp_proj, city_limits_data_proj, .pred = st_within)

phillyrental_proj_1923=phillyrental_proj%>%
  filter(
  year(DATE_POSTED) %in% c(2019:2023)
)

phillyrental_proj_1619=phillyrental_proj%>%
  filter(
  year(DATE_POSTED) %in% c(2016:2019)
)

write.csv(phillyrental_proj_1923,"data/1923rent.csv")

```



### Commercial and office points of interests (Amenities)(alternative in the next section if you do not want to download pbf data)

```{r, eval=FALSE}
# downloading osm data from geofabrik:https://download.geofabrik.de/north-america/us-northeast.html

#input_pbf <- "the pdf file downloaded from the link above"


# get boundary of Philadelphia County
pa_counties <- counties(state = "PA", year = 2023)

# Filter to Philadelphia County
philly_boundary <- subset(pa_counties, NAME == "Philadelphia")

# read the full OSM PBF (you can select layer types like points, lines, polygons)
poi <- oe_read(input_pbf, 
                       boundary = philly_boundary, 
                       boundary_type = "clipsrc", 
                       layer = "points")  # or "lines" / "multipolygons"


keywords <- c("shop","amenity","office","historic","tourism","healthcare",
              "building","leisure")
pattern <- paste0(keywords, collapse = "|")

# ==== Filter by 'other_tags' ====
if ("other_tags" %in% names(poi)) {
  poi$other_tags <- iconv(as.character(poi$other_tags), from = "", to = "UTF-8", sub = "")
  poi$other_tags[is.na(poi$other_tags)] <- ""
  
  poi_filtered <- poi %>%
    filter(grepl(pattern, other_tags, ignore.case = TRUE))
  
  cat("filtered POIs found:", nrow(poi_filtered), "of", nrow(poi), "\n")
  
} 

```

### Alternative: filtered POI if you donot want to download osm data
```{r}

poi_path <- here("data", "filtered poi")
poi_shp_path=file.path(poi_path, "philadelphia_poi_filtered.shp")
poi=st_read(poi_shp_path)
```


```{r}
# get boundary of Philadelphia County
pa_counties <- counties(state = "PA", year = 2023)

# Filter to Philadelphia County
philly_boundary <- subset(pa_counties, NAME == "Philadelphia")

philly_boundary <- st_transform(philly_boundary, 3364)  
poi <- st_transform(poi, 3364)
# ==== Prepare point pattern ====
# Convert sf points to spatstat ppp object
win <- as.owin(st_union(philly_boundary))  # window from county boundary
coords <- st_coordinates(poi)
pp <- ppp(x = coords[,1], y = coords[,2], window = win)

# ==== Run Kernel Density Estimation ====
# Sigma = bandwidth in map units (here, meters)
density_map <- density.ppp(pp, sigma = 300* 3.28084, edge = TRUE, at = "pixels",eps = c(100, 100))

# ==== Convert to raster ====
r_Economic <- rast(density_map)
crs(r_Economic) <- st_crs(philly_boundary)$proj4string
r_Economic <- mask(r_Economic, vect(philly_boundary))

```

### load quartly wage data
```{r}
file_list <- list.files(
  path = "data",
  pattern = ".q1-q4 42101 Philadelphia County, Pennsylvania.csv",
  full.names = TRUE
)
wage_data <- file_list %>%
  set_names() %>% 
  map_df(~ read_csv(.x), .id = "source_file")%>%
  filter(own_title=="Total Covered")%>%
  select(year,qtr,avg_wkly_wage)
```
### merge wage data with evictation data
```{r}
df$quarter=quarter(df$week_date)
df$year=year(df$week_date)
df$yearqu=paste0(df$year, df$quarter)
wage_data$yearqu=paste0(wage_data$year,wage_data$qtr)
df=wage_data%>%
  select(yearqu,avg_wkly_wage)%>%
  right_join(df,by="yearqu")
  
```

### merge with different CPI and unemployment rate per month in Philadelphia
```{r}
food=read.csv(here('data/food.csv'))
electricity=read.csv(here('data/electricity.csv'))
commodities=read.csv(here('data/commodities.csv'))


df$month=month(df$week_date)
electricity$month=as.numeric(gsub("M","",electricity$Period))
df$yearm=paste0(df$year,df$month)
electricity$yearm=paste0(electricity$Year,electricity$month)

df=electricity%>%
  mutate(electricitycpi=Value)%>%
  select(yearm,electricitycpi)%>%
  right_join(df,by="yearm")

food$first_of_month=ym(food$Label)
df=food%>%
  mutate(foodcpi=Value)%>%
  select(first_of_month,foodcpi)%>%
  right_join(df, by="first_of_month")

df.test=df%>%
  arrange(week_date)
```



# PHASE 2: EXPLORATORY DATA ANALYSIS

### Distribution of evictaion rate (histogram)
```{r}
# Calculate the median / mean to plot
filings_median <- median(df$filings_avg, na.rm = TRUE)

ggplot(df, aes(filings_avg)) +
  geom_histogram(bins = 60, fill = "darkseagreen3", color = "black") +
  geom_vline(xintercept = filings_median, linetype = 5) +
  annotate("text",
           x = filings_median, 
           y = 6300, 
           label = "Median",
           hjust = -0.2, 
           color = "black", 
           size = 3) +
  scale_x_continuous() +
  labs(title = "Distribution of Weekly Eviction Rate",
       subtitle = "For Philadelphia Residential Properties in 2023-2024",
       x = "Eviction Rate",
       y = "Count") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

```

### Distribution of evictaion rate by week (histogram)
```{r}
# Calculate the median / mean to plot
df$year=year(df$week_date)
df$yearmonth <- ym(format(df$week_date, "%Y-%m"))
filings_median <- median(df$filings_avg, na.rm = TRUE)

ggplot(df) +
  geom_col(aes(x =yearmonth , y = filings_avg), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df$yearmonth), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(title = "Weekly Average Eviction Filings",
       subtitle = "For Philadelphia Residential Properties in 2023-2024",
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )


df$month=month(df$week_date)




df_2020=df%>%
  filter(year==2020)

df_1619Q <- df_2020sum1916 %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_1619Q=df_1619Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))


df_2020Q <- df_2020sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2020Q=df_2020Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))


df_2021Q <- df_2021sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2021Q=df_2021Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))


df_2022Q <- df_2022sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2022Q=df_2022Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))

df_2023Q <- df_2023sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2023Q=df_2023Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))

df_2024Q <- df_2024sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2024Q=df_2024Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))

df_2025Q <- df_2025sum %>%
  mutate(q = case_when(
    month %in% c(1, 2, 3) ~ 1,
    month %in% c(4, 5, 6) ~ 2,
    month %in% c(7, 8, 9) ~ 3,
    month %in% c(10, 11, 12) ~ 4
  ))

df_2025Q=df_2025Q%>%
  group_by(q)%>%
  summarise(sum=sum(sum))




plt1=ggplot(df_1619Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_1619Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt2=ggplot(df_2020Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2020Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt3=ggplot(df_2021Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2021Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt4=ggplot(df_2022Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2022Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt5=ggplot(df_2023Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2023Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )


plt6=ggplot(df_2024Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2024Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )


plt7=ggplot(df_2025Q) +
  geom_col(aes(x =q , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2025Q$q), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

library(ggpubr)
ggarrange(plt1, plt2, plt3,plt4,plt5,plt6,plt7, ncol = 4, nrow = 2, align = 'h')

```



```{r}
df_2020=df%>%
  filter(year==2020)

df_2020sum1916=df_2020%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg_prepandemic_baseline))
df_2020sum=df_2020%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))
df_2021=df%>%
  filter(year==2021)
df_2021sum=df_2021%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))
df_2022=df%>%
  filter(year==2022)
df_2022sum=df_2022%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))
df_2023=df%>%
  filter(year==2023)
df_2023sum=df_2023%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))

df_2024=df%>%
  filter(year==2024)
df_2024sum=df_2024%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))

df_2025=df%>%
  filter(year==2025)
df_2025sum=df_2025%>%
  group_by(month)%>%
  summarise(sum=sum(filings_avg))

plt1=ggplot(df_2020sum1916) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2020sum1916$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt2=ggplot(df_2020sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2020$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt3=ggplot(df_2021sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2021$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt4=ggplot(df_2022sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2022$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

plt5=ggplot(df_2023sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2023$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )


plt6=ggplot(df_2024sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2023$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )


plt7=ggplot(df_2025sum) +
  geom_col(aes(x =month , y = sum), 
           fill = "darkseagreen3", color = "black") +
  geom_hline(yintercept = filings_median, linetype = 5) +
  annotate("text",
           x = max(df_2023$month), 
           y = filings_median, 
           label = paste("Median:", round(filings_median, 1)),
           hjust = 1, vjust = -0.5,
           color = "black", 
           size = 3) +
  labs(
       x = "Week",
       y = "Average Filings") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

library(ggpubr)
ggarrange(plt1, plt2, plt3,plt4,plt5,plt6,plt7, ncol = 4, nrow = 2, align = 'h')
windows(width = 15, height =5 )
plt1+plt2+plt3+plt4+plt5
```

### spatial join
```{r}

# join census variables to tract shapefile
philly_tracts <- philly_tract_sf %>%
  left_join(philly_tract_data, by = "GEOID")

# KDE POI density to census tracts
philly_tracts_projected <- st_transform(philly_tracts, 3364)

philly_tracts_projected$poi_density <- terra::extract(
  r_Economic, 
  vect(philly_tracts_projected), 
  fun = mean, 
  na.rm = TRUE
)[, 2]

philly_tracts_final <- st_transform(philly_tracts_projected, 4326)

```

```{r}
# aggregate eviction data by tract and QUARTER
df_evictions <- df %>%
  group_by(GEOID, year, quarter) %>%
  summarise(
    eviction_count = sum(filings_avg, na.rm = TRUE),
    eviction_baseline = sum(filings_avg_prepandemic_baseline, na.rm = TRUE),
    avg_wkly_wage = first(avg_wkly_wage),
    foodcpi = first(foodcpi),
    electricitycpi = first(electricitycpi),
    .groups = "drop"
  )

# join everything into final modeling dataset
model_data <- philly_tracts_final %>%
  left_join(df_evictions, by = "GEOID") %>%
  filter(!is.na(eviction_count))

# check result
glimpse(model_data)
```


```{r}
# aggregate eviction data by tract and MONTH
df_evictions_monthly <- df %>%
  group_by(GEOID, year, month) %>%
  summarise(
    eviction_count = sum(filings_avg, na.rm = TRUE),
    eviction_baseline = sum(filings_avg_prepandemic_baseline, na.rm = TRUE),
    foodcpi = first(foodcpi),           # monthly - OK
    electricitycpi = first(electricitycpi),  # monthly - OK
    .groups = "drop"
  ) %>%
  mutate(quarter = ceiling(month / 3))  # add quarter for wage join

# join wage separately (since it's quarterly)
df_evictions_monthly <- df_evictions_monthly %>%
  left_join(
    wage_data %>% select(year, qtr, avg_wkly_wage) %>% rename(quarter = qtr),
    by = c("year", "quarter")
  )

model_data_monthly <- philly_tracts_final %>%
  left_join(df_evictions_monthly, by = "GEOID") %>%
  filter(!is.na(eviction_count))

# check result
glimpse(model_data_monthly)
```


```{r}
colSums(is.na(model_data_monthly))
```




