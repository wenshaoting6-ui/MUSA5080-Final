---
title: "Technical Appendix"
format: 
  html:
    toc: true
    toc-location: left
    code-fold: show
    theme: cosmo
---

```{r}
library(tidycensus)
library(tidyverse)
library(here)
library(lubridate)
library(dplyr)
library(sf)
library(tigris)
library(spatstat)
library(terra)
library(ggplot2)
df=read.csv(here("data/philadelphia_weekly_2020_2021 (1).csv"))
df$week_date <- ymd(df$week_date)
df$first_of_month=floor_date(df$week_date,"month")
df$days_since_first=as.numeric(df$week_date-df$first_of_month)
df$week_of_month <- ceiling((df$days_since_first + 1) / 7)
summary(df)

```

```{r}
acs_tables <- load_variables(year = 2023, dataset = "acs5", cache = TRUE)

View(acs_tables)
```

```{r}
census_path <- here("data", "Philly Census")

census_shp_path <- file.path(census_path, "philly_tract.shp")

philly_tract_sf <- st_read(census_shp_path, quiet = TRUE)
```


Variables Collected:

Median gross rent: (B25064)

Race: (B02001)

Median household income: (B19013)

% of Renter: (B25003)

Year Built(renter): (B25036)

Number of Room: (B25017)

Room Per Household: (B25020)

Family Structure: (B11001)

Unemployment in labor force: (C18120)

Gross Rent as a Percentage of Household Income: (B25070)

### census data collected

```{r api key, eval=FALSE, include=FALSE}

census_api_key <- ("138db656646183a18ae51e4a7c1e1f5cd64d4b40")

# Define parameters
my_state  <- "Pennsylvania"
my_county <- "Philadelphia"
acs_year  <- 2023

# Median Gross Rent
median_rent <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25064_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rent = estimate)

# Race
race <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B02001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_pop = B02001_001,
    white = B02001_002,
    black = B02001_003,
    asian = B02001_005,
    pct_white = 100 * white / total_pop,
    pct_black = 100 * black / total_pop,
    pct_asian = 100 * asian / total_pop
  ) %>%
  select(GEOID, total_pop, pct_white, pct_black, pct_asian)

# Median Household Income
median_income <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B19013_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_hh_income = estimate)

# Percent Renter
tenure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_occupied = B25003_001,
    renter_occupied = B25003_003,
    pct_renter = 100 * renter_occupied / total_occupied
  ) %>%
  select(GEOID, pct_renter)

# Median Year Built - Renter Occupied
year_built_renter <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25037_003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_year_built_renter = estimate)

# Number of Rooms
num_rooms <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25017_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, aggregate_rooms = estimate)

# Median Rooms Per Household 
rooms_per_hh <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25018_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rooms = estimate)

# Family Structure 
family_structure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B11001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_hh = B11001_001,
    family_hh = B11001_002,
    nonfamily_hh = B11001_007,
    pct_family = 100 * family_hh / total_hh
  ) %>%
  select(GEOID, total_hh, pct_family)

# Unemployment in Labor Force (C18120)
unemployment <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "C18120",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    in_labor_force = C18120_002,
    unemployed = C18120_004,
    pct_unemployed = 100 * unemployed / in_labor_force
  ) %>%
  select(GEOID, pct_unemployed)

# Gross Rent as Percentage of Household Income ()
rent_burden <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25070",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total = B25070_001,
    # Rent burdened = paying 30%+ of income on rent
    rent_burdened = B25070_007 + B25070_008 + B25070_009 + B25070_010,
    pct_rent_burdened = 100 * rent_burdened / total
  ) %>%
  select(GEOID, pct_rent_burdened)

#Join All data
philly_tract_data <- median_rent %>%
  left_join(race, by = "GEOID") %>%
  left_join(median_income, by = "GEOID") %>%
  left_join(tenure, by = "GEOID") %>%
  left_join(year_built_renter, by = "GEOID") %>%
  left_join(num_rooms, by = "GEOID") %>%
  left_join(rooms_per_hh, by = "GEOID") %>%
  left_join(family_structure, by = "GEOID") %>%
  left_join(unemployment, by = "GEOID") %>%
  left_join(rent_burden, by = "GEOID")
```


### Commercial and office points of interests (Amenities)(alternative in the next section if you do not want to download pbf data)

```{r, eval=FALSE}
# downloading osm data from geofabrik:https://download.geofabrik.de/north-america/us-northeast.html

#input_pbf <- "the pdf file downloaded from the link above"


# get boundary of Philadelphia County
pa_counties <- counties(state = "PA", year = 2023)

# Filter to Philadelphia County
philly_boundary <- subset(pa_counties, NAME == "Philadelphia")

# read the full OSM PBF (you can select layer types like points, lines, polygons)
poi <- oe_read(input_pbf, 
                       boundary = philly_boundary, 
                       boundary_type = "clipsrc", 
                       layer = "points")  # or "lines" / "multipolygons"


keywords <- c("shop","amenity","office","historic","tourism","healthcare",
              "building","leisure")
pattern <- paste0(keywords, collapse = "|")

# ==== Filter by 'other_tags' ====
if ("other_tags" %in% names(poi)) {
  poi$other_tags <- iconv(as.character(poi$other_tags), from = "", to = "UTF-8", sub = "")
  poi$other_tags[is.na(poi$other_tags)] <- ""
  
  poi_filtered <- poi %>%
    filter(grepl(pattern, other_tags, ignore.case = TRUE))
  
  cat("filtered POIs found:", nrow(poi_filtered), "of", nrow(poi), "\n")
  
} 

```

### Alternative: filtered POI if you donot want to download osm data
```{r}

poi_path <- here("data", "filtered poi")
poi_shp_path=file.path(poi_path, "philadelphia_poi_filtered.shp")
poi=st_read(poi_shp_path)
```


```{r}
# get boundary of Philadelphia County
pa_counties <- counties(state = "PA", year = 2023)

# Filter to Philadelphia County
philly_boundary <- subset(pa_counties, NAME == "Philadelphia")

philly_boundary <- st_transform(philly_boundary, 3364)  
poi <- st_transform(poi, 3364)
# ==== Prepare point pattern ====
# Convert sf points to spatstat ppp object
win <- as.owin(st_union(philly_boundary))  # window from county boundary
coords <- st_coordinates(poi)
pp <- ppp(x = coords[,1], y = coords[,2], window = win)

# ==== Run Kernel Density Estimation ====
# Sigma = bandwidth in map units (here, meters)
density_map <- density.ppp(pp, sigma = 300* 3.28084, edge = TRUE, at = "pixels",eps = c(100, 100))

# ==== Convert to raster ====
r_Economic <- rast(density_map)
crs(r_Economic) <- st_crs(philly_boundary)$proj4string
r_Economic <- mask(r_Economic, vect(philly_boundary))

```

# PHASE 2: EXPLORATORY DATA ANALYSIS

### Distribution of evictaion rate (histogram)
```{r}
# Calculate the median / mean to plot
filings_median <- median(df$filings_avg, na.rm = TRUE)

ggplot(df, aes(filings_avg)) +
  geom_histogram(bins = 60, fill = "darkseagreen3", color = "black") +
  geom_vline(xintercept = filings_median, linetype = 5) +
  annotate("text",
           x = filings_median, 
           y = 6300, 
           label = "Median",
           hjust = -0.2, 
           color = "black", 
           size = 3) +
  scale_x_continuous() +
  labs(title = "Distribution of Weekly Eviction Rate",
       subtitle = "For Philadelphia Residential Properties in 2023-2024",
       x = "Eviction Rate",
       y = "Count") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold")
  )

```

