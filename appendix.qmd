---
title: "Technical Appendix"
format: 
  html:
    toc: true
    toc-location: left
    code-fold: show
    theme: cosmo
---

```{r}
library(tidycensus)
library(tidyverse)
library(here)
library(lubridate)
library(dplyr)
library(sf)
library(tigris)
library(spatstat)
library(terra)
library(ggplot2)
library(arrow)
library(tigris)
library(car)
library(lmtest)
```
```{r}
df=read.csv(here("data/philadelphia_monthly_2020_2021.csv"))
df$week_date <- my(df$month)
df$first_of_month=floor_date(df$week_date,"month")
summary(df)
```


```{r}
acs_tables <- load_variables(year = 2023, dataset = "acs5", cache = TRUE)

```

```{r}
census_path <- here("data", "Philly Census")

census_shp_path <- file.path(census_path, "philly_tract.shp")

philly_tract_sf <- st_read(census_shp_path, quiet = TRUE)
```


Variables Collected:

Median gross rent: (B25064)

Race: (B02001)

Median household income: (B19013)

% of Renter: (B25003)

Year Built(renter): (B25036)

Number of Room: (B25017)

Room Per Household: (B25020)

Family Structure: (B11001)

Unemployment in labor force: (C18120)

Gross Rent as a Percentage of Household Income: (B25070)

### census data collected

```{r api key, eval=TRUE, include=FALSE}

census_api_key <- ("138db656646183a18ae51e4a7c1e1f5cd64d4b40")

# Define parameters
my_state  <- "Pennsylvania"
my_county <- "Philadelphia"
acs_year  <- 2023

# Median Gross Rent
median_rent <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25064_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rent = estimate)

# Race
race <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B02001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_pop = B02001_001,
    white = B02001_002,
    black = B02001_003,
    asian = B02001_005,
    pct_white = 100 * white / total_pop,
    pct_black = 100 * black / total_pop,
    pct_asian = 100 * asian / total_pop
  ) %>%
  select(GEOID, total_pop, pct_white, pct_black, pct_asian)

# Median Household Income
median_income <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B19013_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_hh_income = estimate)

# Percent Renter
tenure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_occupied = B25003_001,
    renter_occupied = B25003_003,
    pct_renter = 100 * renter_occupied / total_occupied
  ) %>%
  select(GEOID, pct_renter)

# Median Year Built - Renter Occupied
year_built_renter <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25037_003",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_year_built_renter = estimate)

# Number of Rooms
num_rooms <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25017_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, aggregate_rooms = estimate)

# Median Rooms Per Household 
rooms_per_hh <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  variables = "B25018_001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, median_rooms = estimate)

# Family Structure 
family_structure <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B11001",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total_hh = B11001_001,
    family_hh = B11001_002,
    nonfamily_hh = B11001_007,
    pct_family = 100 * family_hh / total_hh
  ) %>%
  select(GEOID, total_hh, pct_family)

# Unemployment in Labor Force (C18120)
unemployment <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "C18120",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    in_labor_force = C18120_002,
    unemployed = C18120_004,
    pct_unemployed = 100 * unemployed / in_labor_force
  ) %>%
  select(GEOID, pct_unemployed)

# Gross Rent as Percentage of Household Income ()
rent_burden <- get_acs(
  geography = "tract",
  state = my_state,
  county = my_county,
  table = "B25070",
  year = acs_year,
  survey = "acs5"
) %>%
  select(GEOID, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    total = B25070_001,
    # Rent burdened = paying 30%+ of income on rent
    rent_burdened = B25070_007 + B25070_008 + B25070_009 + B25070_010,
    pct_rent_burdened = 100 * rent_burdened / total
  ) %>%
  select(GEOID, pct_rent_burdened)

#Join All data
philly_tract_data <- median_rent %>%
  left_join(race, by = "GEOID") %>%
  left_join(median_income, by = "GEOID") %>%
  left_join(tenure, by = "GEOID") %>%
  left_join(year_built_renter, by = "GEOID") %>%
  left_join(num_rooms, by = "GEOID") %>%
  left_join(rooms_per_hh, by = "GEOID") %>%
  left_join(family_structure, by = "GEOID") %>%
  left_join(unemployment, by = "GEOID") %>%
  left_join(rent_burden, by = "GEOID")

philly_tract=tracts( state = 'PA',
        county = '101',
        year = 2023
)

philly_tract_sf=philly_tract%>%
  select(GEOID,geometry)
```


### Dewey rental data
```{r}
#input data
folder_path <- "data/rental-in-philly"
all_parquet_files <- open_dataset(
  sources = folder_path, 
  format = "parquet"
)
combined_df <- all_parquet_files %>%
  collect()

#reproject it
rental_shp=combined_df%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

#input city limit data  
api_url <- "https://services.arcgis.com/fLeGjb7u4uXqeF9q/arcgis/rest/services/City_Limits/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
city_limits_data <- st_read(api_url)


rental_shp_proj <- st_transform(rental_shp, crs = 32618)
city_limits_data_proj <- st_transform(city_limits_data, crs = 32618)

#filter to philadelphia
phillyrental_proj <- st_filter(rental_shp_proj, city_limits_data_proj, .pred = st_within)

#filter to different times
phillyrental_proj_1923=phillyrental_proj%>%
  filter(
  year(DATE_POSTED) %in% c(2019:2023)
)

phillyrental_proj_1619=phillyrental_proj%>%
  filter(
  year(DATE_POSTED) %in% c(2016:2019)
)

philly_tract_sf=st_transform(philly_tract_sf,crs=32618)

#merge with census tract
phillyrental_proj_1923=phillyrental_proj_1923%>%
  st_join(philly_tract_sf,join = st_within)

phillyrental_proj_1619=phillyrental_proj_1619%>%
  st_join(philly_tract_sf,join = st_within)


```


### load quartly wage data
```{r}
file_list <- list.files(
  path = "data",
  pattern = ".q1-q4 42101 Philadelphia County, Pennsylvania.csv",
  full.names = TRUE
)
wage_data <- file_list %>%
  set_names() %>% 
  map_df(~ read_csv(.x), .id = "source_file")%>%
  filter(own_title=="Total Covered")%>%
  select(year,qtr,avg_wkly_wage)
```
### merge wage data with evictation data
```{r}
df$quarter=quarter(df$week_date)
df$year=year(df$week_date)
df$yearqu=paste0(df$year, df$quarter)
wage_data$yearqu=paste0(wage_data$year,wage_data$qtr)
df=wage_data%>%
  select(yearqu,avg_wkly_wage)%>%
  right_join(df,by="yearqu")
  
```

### merge with different CPI and unemployment rate per month in Philadelphia
```{r}
food=read.csv(here('data/food.csv'))
electricity=read.csv(here('data/electricity.csv'))
commodities=read.csv(here('data/commodities.csv'))

#merge with electricity cpi
df$month=month(df$week_date)
electricity$month=as.numeric(gsub("M","",electricity$Period))
df$yearm=paste0(df$year,df$month)
electricity$yearm=paste0(electricity$Year,electricity$month)

df=electricity%>%
  mutate(electricitycpi=Value)%>%
  select(yearm,electricitycpi)%>%
  right_join(df,by="yearm")

#merge with food cpi
food$first_of_month=ym(food$Label)
df=food%>%
  mutate(foodcpi=Value)%>%
  select(first_of_month,foodcpi)%>%
  right_join(df, by="first_of_month")

df=df%>%
  arrange(week_date)%>%
  fill(foodcpi, .direction = "up")

#merge with commodities cpi

commodities = commodities %>%
  mutate(
    comcpi = Value, 
    half_year_date = case_when(
      Period == "S01" ~ ymd(paste(Year, "01", "01")), # Half 1 -> Jan 1
      Period == "S02" ~ ymd(paste(Year, "07", "01"))  # Half 2 -> Jul 1
    )
  ) %>%
  select(half_year_date, comcpi)

df = df %>%
  left_join(commodities, by = c("first_of_month" = "half_year_date"))

df = df %>%
  arrange(week_date) %>%
  fill(comcpi, .direction = "down")

```

### merge with unemployment data
```{r}
unemployment=read.csv("data/unemployment.csv")
unemployment$week_date=ym(unemployment$Label)
df=unemployment%>%
  mutate(unemployment_rate=Value)%>%
  select(unemployment_rate,week_date)%>%
  right_join(df,by="week_date")


```


### merge with census data 
```{r}
df_census=df%>%
  left_join(philly_tract_data,by="GEOID")


df_census_sf=df_census%>%
  left_join(philly_tract_sf,by="GEOID")

```


### merge with rent data
```{r}
#calculate rent by month and tract
rent_by_month_tract=phillyrental_proj_1923%>%
  st_drop_geometry()%>%
  mutate(date=format(DATE_POSTED,"%Y-%m"))%>%
  select(GEOID,RENT_PRICE,date,NEIGHBORHOOD)%>%
  group_by(GEOID,date)%>%
    summarise(median_rent=median(RENT_PRICE))
```


### Final data frame

```{r}

#merge with eviction data
df_final=df_census_sf%>%
  mutate(date=format(week_date,"%Y-%m"))%>%
  filter(year(week_date) %in% c(2020:2023))%>%
  left_join(rent_by_month_tract,by=c("date","GEOID"))%>%
  select(GEOID,unemployment_rate,foodcpi,electricitycpi,avg_wkly_wage,
         filings_avg,comcpi,total_pop,pct_white,pct_black,pct_asian,
         median_hh_income,pct_renter,median_year_built_renter,aggregate_rooms,
         median_rooms,total_hh,pct_family,median_rent.y)
```















# Regression
```{r}

df_final$evibypop=df_final$filings_avg/df_final$total_pop
set.seed(123)
n <- nrow(df_final)

# 70% training, 30% testing
train_indices <- sample(1:n, size = 0.7 * n)
train_data <- df_final[train_indices, ]
test_data <- df_final[-train_indices, ]
```

```{r}
#run regression based on houses own characteristic
options(scipen = 999)

model1=lm(evibypop~median_rent.y+foodcpi+electricitycpi+avg_wkly_wage+median_rent.y+pct_white+median_hh_income+pct_renter+unemployment_rate+median_year_built_renter+aggregate_rooms+pct_family+total_hh+pct_black+pct_asian+comcpi,data=df_final)
summary(model1)

```

```{r}
vif(model1)
```


```{r}
bptest(model1)
```

```{r}
test=df_census_sf%>%
  filter(GEOID=="42101000101")%>%
  select(filings_avg,week_date)
```



```{r}
#p-value is way too small, implying more variables may be needed (make sense)

#calculate the RMSE
model_train_1 <- lm(evibypop~median_rent.y+foodcpi+electricitycpi+avg_wkly_wage+median_rent.y+pct_white+median_hh_income+pct_renter+unemployment_rate+median_year_built_renter+aggregate_rooms+pct_family+total_hh+pct_black+pct_asian+comcpi,data = train_data)
test_predictions_1 <- predict(model_train_1, newdata = test_data)
rmse_test_1 <- sqrt(mean((test_data$log_price - test_predictions_1)^2,na.rm = TRUE))
rmse_train_1 <- summary(model_train_1)$sigma


plot(model1)
```

